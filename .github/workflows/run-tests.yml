on: ["push", "pull_request"]

name: "Build and test"

jobs:

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

#      - name: download qjsc # TODO cache
#         # file uploaded in https://github.com/jsqry/jsqry-cli2/issues/15
#        run: |
#          wget https://github.com/jsqry/jsqry-cli2/files/5001636/qjsc.tar.gz
#
#      - name: extract qjsc
#        run: |
#          tar xzvf qjsc.tar.gz

      - name: "download qjsc" # TODO cache
        run: |
          echo "quickjs-2020-07-05" > .qjsf
          wget https://bellard.org/quickjs/$(cat .qjsf).tar.xz

      - name: "extract quickjs"
        run: |
          tar xvf ./$(cat .qjsf).tar.xz

      - name: "compile qjsc"
        run: |
          cd $(cat .qjsf)
          pwd
          make qjsc libquickjs.a

      - name: "build jsqry"
        run: |
          pwd
          mkdir build
          cd build
          pwd
          ls -l
          ls -l ..
          ../$(cat ../.qjsf)/qjsc ../jsqry-cli.js -o jsqry

      - name: "prepare test tool"
        run: |
          wget https://github.com/adolfopa/tush/archive/master.zip -O./tush.zip
          unzip ./tush.zip

      - name: "run tests"
        run: |
          pwd
          export PATH=./tush-master/bin:$PATH
          echo $PATH
          ./tests.sh


